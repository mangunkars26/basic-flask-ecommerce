{% extends 'base.html' %}
{% block content %}
<h2>Your Cart</h2>
<table class="table table-bordered">
    <thead>
        <tr>
            <th scope="col">Product</th>
            <th scope="col">Quantity</th>
            <th scope="col">Price</th>
            <th scope="col">Subtotal</th>
            <th scope="col">Action</th>
        </tr>
    </thead>
    <tbody>
        {% for item in cart.items %}
        <tr>
            <td>{{ item.product.name }}</td>
            <td>
                <input type="number" class="form-control quantity-input" data-product-id="{{ item.product.id }}" value="{{ item.quantity }}" min="1">
            </td>
            <td>${{ item.product.price }}</td>
            <td>${{ item.subtotal }}</td>
            <td>
                <button class="btn btn-sm btn-danger remove-from-cart" data-product-id="{{ item.product.id }}">Remove</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<p><strong>Total: ${{ cart.total }}</strong></p>
<a href="{{ url_for('main.checkout') }}" class="btn btn-success">Proceed to Checkout</a>

<script>
// Update cart quantity
document.querySelectorAll('.quantity-input').forEach(input => {
    input.addEventListener('change', function() {
        const productId = this.getAttribute('data-product-id');
        const quantity = this.value;
        fetch(`/update_cart/${productId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ quantity: quantity })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Refresh page to update cart
            } else {
                alert('Error updating cart.');
            }
        });
    });
});

// Remove from cart
document.querySelectorAll('.remove-from-cart').forEach(button => {
    button.addEventListener('click', function() {
        const productId = this.getAttribute('data-product-id');
        fetch(`/remove_from_cart/${productId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Refresh page to update cart
            } else {
                alert('Error removing product from cart.');
            }
        });
    });
});
</script>
{% endblock %}
